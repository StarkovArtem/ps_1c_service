# Скрипты для обслуживания серверов 1С на Windows

Набор PowerShell скриптов для автоматизации обслуживания серверов 1С предприятия.

## Установка

Для установки выполните команду:

```powershell
irm https://raw.githubusercontent.com/StarkovArtem/ps_1c_service/refs/heads/main/setup.ps1 | iex
```

После выполнения команды откроется меню установки, где можно выбрать путь для установки скриптов (по умолчанию `C:\ps_1c_service`).

## Описание скриптов

### Скрипт №1: `check-1C-lgd_bases.ps1`

Проверяет все базы локального кластера 1С на предмет использования старого формата лога (lgd).

**Функциональность:**
- Сканирует все информационные базы локального кластера
- Проверяет формат файлов логов
- Выявляет базы, использующие устаревший формат lgd
- Формирует отчет о результатах проверки

### Скрипт №2: `shrink_1C_log.ps1`

Управляет файлами логов 1С: удаляет или перемещает файлы логов сверх установленного лимита.

**Функциональность:**
- Анализирует размер и количество файлов логов
- Удаляет старые логи согласно заданным лимитам
- Сохраняет необходимое количество последних логов
- Поддерживает настройку лимитов хранения

**Конфигурационные параметры:**

```powershell
# Конфигурация
$LogFolderPath = "C:\Program Files\1cv8\srvinfo"  # Путь к папке с логами 1С
$MaxSizeMB = 500                                  # Максимальный размер логов в МБ
$LogExtensions = @("*.lgp", "*.lgx")              # Расширения файлов логов для обработки

# Параметры обработки
$DeleteOverSize = $false                          # true - удалять файлы превышающие лимит, false - только показывать
$MoveTo = ""                                      # UNC-путь к сетевой папке для перемещения (например: "\\server\logs\1C")
$NetworkLogin = ""                                # Логин для доступа к сетевой папке
$NetworkPassword = ""                             # Пароль для доступа к сетевой папке
```

**Описание параметров:**
- **`$LogFolderPath`** - путь к папке с логами кластера 1С (по умолчанию стандартный путь установки)
- **`$MaxSizeMB`** - максимальный допустимый размер всех логов в мегабайтах (при превышении будут удалены/перемещены самые старые логи)
- **`$LogExtensions`** - массив расширений файлов логов для обработки (по умолчанию обрабатываются lgp и lgx файлы)
- **`$DeleteOverSize`** - режим работы: `$true` - фактически удалять файлы, `$false` - только показывать какие файлы будут удалены (режим предпросмотра)
- **`$MoveTo`** - если указан, файлы будут перемещены в эту сетевую папку вместо удаления
- **`$NetworkLogin`** и **`$NetworkPassword`** - учетные данные для доступа к сетевой папке, если требуется аутентификация

### Скрипт №3: `install-1c-ras.ps1`

Автоматическая установка и настройка RAS (Remote Administration Server) сервера для 1С:Предприятие.

**Функциональность:**
- Автоматически запрашивает права администратора
- Проверяет наличие установленной платформы 1С
- Создает службу Windows для RAS сервера
- Настраивает правила брандмауэра для указанного порта
- Проверяет работоспособность установленной службы

**Параметры запуска:**

```powershell
.\install-1c-ras.ps1 [-RASPort <порт>] [-InstallPath <путь>] [-LogPath <путь>] [-ServiceName <имя>] [-ClusterInstance <кластер>]
```

**Параметры:**
- **`-RASPort`** - порт для RAS сервера (по умолчанию: 1545)
- **`-InstallPath`** - путь установки (по умолчанию: "C:\Program Files\1C\RAS")
- **`-LogPath`** - путь к логам (по умолчанию: "C:\ProgramData\1C\ras\logs")
- **`-ServiceName`** - имя службы Windows (по умолчанию: "1C_RAS_Server")
- **`-ClusterInstance`** - экземпляр кластера (по умолчанию: "localhost")

**Примеры использования:**

```powershell
# Установка с параметрами по умолчанию
.\install-1c-ras.ps1

# Установка на нестандартный порт
.\install-1c-ras.ps1 -RASPort 1540

# Установка с указанием всех параметров
.\install-1c-ras.ps1 -RASPort 1545 -InstallPath "D:\1C\RAS" -LogPath "D:\Logs\1C\RAS" -ServiceName "MyRASService"
```

### Скрипт №4: `manage-1c-ras.ps1`

Управление установленным RAS сервером 1С.

**Функциональность:**
- Просмотр статуса службы RAS
- Запуск, остановка и перезапуск службы
- Просмотр логов службы
- Проверка сетевого подключения

**Использование:**

```powershell
.\manage-1c-ras.ps1 <команда> [-ServiceName <имя>] [-Port <порт>]
```

**Команды:**
- **`status`** - показать статус службы и проверить порт
- **`start`** - запустить службу RAS
- **`stop`** - остановить службу RAS
- **`restart`** - перезапустить службу RAS
- **`logs`** - показать последние записи из логов
- **`help`** - показать справку по использованию

**Примеры использования:**

```powershell
# Проверить статус службы
.\manage-1c-ras.ps1 status

# Запустить службу
.\manage-1c-ras.ps1 start

# Показать логи
.\manage-1c-ras.ps1 logs

# Управление службой с нестандартным именем
.\manage-1c-ras.ps1 status -ServiceName "MyRASService" -Port 1540
```

## Использование

После установки все скрипты будут доступны в выбранной директории. Для запуска скриптов используйте PowerShell.

## Особенности RAS сервера

RAS (Remote Administration Server) позволяет:
- Удаленно управлять кластерами серверов 1С
- Мониторить состояние серверов
- Выполнять административные задачи через сеть
- Интегрироваться с системами мониторинга

После установки RAS сервер будет доступен по указанному порту и может быть проверен командой:
```powershell
Test-NetConnection -ComputerName localhost -Port 1545
```

## Требования

- Windows Server/Windows 10/11
- PowerShell 5.0 или выше
- Права администратора (для некоторых операций)
- Установленная платформа 1С:Предприятие (для RAS сервера)

## Лицензия

MIT License